<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–Ω–∞—Ç–∞ {{ room.room_id }} - Alias</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</h1>
            <div class="room-id">{{ room.room_id }}</div>
        </div>
        
        <div class="room-info">
            <div class="info-row">
                <span>–°–æ–∑–¥–∞—Ç–µ–ª—å:</span>
                <span>{{ room.creator_name }}</span>
            </div>
            <div class="info-row">
                <span>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</span>
                <span class="difficulty-badge {{ room.difficulty }}">
                    {% if room.difficulty == 'easy' %}üéØ –õ–µ–≥–∫–∏–π
                    {% elif room.difficulty == 'medium' %}üéØ –°—Ä–µ–¥–Ω–∏–π
                    {% elif room.difficulty == 'hard' %}üéØ –°–ª–æ–∂–Ω—ã–π
                    {% endif %}
                </span>
            </div>
            <div class="info-row">
                <span>–°—Ç–∞—Ç—É—Å:</span>
                <span id="roomStatus">
                    {% if room.is_game_started %}
                    <span style="color: #51cf66;">üéÆ –ò–≥—Ä–∞ –∏–¥–µ—Ç</span>
                    {% else %}
                    <span style="color: #ffc107;">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</span>
                    {% endif %}
                </span>
            </div>
        </div>
        
        <div class="teams-container">
            <div class="team team-a">
                <div class="team-title">üë• –ö–æ–º–∞–Ω–¥–∞ A</div>
                <div class="player-count" id="teamACount">–ò–≥—Ä–æ–∫–æ–≤: 0/4</div>
                <div class="players-list" id="teamAPlayers"></div>
            </div>
            
            <div class="team team-b">
                <div class="team-title">üë• –ö–æ–º–∞–Ω–¥–∞ B</div>
                <div class="player-count" id="teamBCount">–ò–≥—Ä–æ–∫–æ–≤: 0/4</div>
                <div class="players-list" id="teamBPlayers"></div>
            </div>
        </div>
        
        <div class="join-buttons" id="joinButtons">
            <button class="btn btn-join-a" onclick="joinTeam('A')" id="joinTeamABtn">
                ‚ûï –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ A
            </button>
            <button class="btn btn-join-b" onclick="joinTeam('B')" id="joinTeamBBtn">
                ‚ûï –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ B
            </button>
        </div>
        
        <button class="btn btn-leave" onclick="leaveRoom()" id="leaveBtn">
            üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>
        
        {% if room.creator_id == current_user_id %}
        <button class="btn btn-start" onclick="startGame()" id="startButton">
            üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
        </button>
        {% endif %}
        
        <div class="share-link">
            <button class="share-btn" onclick="shareRoom()" id="shareBtn">
                üì¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
            </button>
        </div>
        
        <div class="message error" id="errorMessage"></div>
        <div class="message success" id="successMessage"></div>
        <div id="roomMeta" data-creator="{{ room.creator_id }}" style="display:none"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        const user = tg.initDataUnsafe?.user;
        let currentUser = null;
        
        if (user) {
            currentUser = {
                id: user.id,
                username: user.username || `User${user.id}`
            };
        } else {
            currentUser = {
                id: Date.now(),
                username: 'TestUser'
            };
        }
        
        const roomId = '{{ room.room_id }}';
        const roomCreatorId = Number(document.getElementById('roomMeta').dataset.creator);
        const isCreator = roomCreatorId === currentUser.id;
        let currentTeam = null;
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        async function updatePlayers() {
            try {
                const response = await fetch(`/api/room/${roomId}/`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.is_game_started) {
                        window.location.href = `/game/${roomId}/`;
                        return;
                    }
                    
                    document.getElementById('teamACount').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${data.team_a_count}/4`;
                    document.getElementById('teamBCount').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${data.team_b_count}/4`;
                    
                    const teamAList = document.getElementById('teamAPlayers');
                    teamAList.innerHTML = '';
                    
                    data.team_a.forEach(player => {
                        const isCurrent = player.user_id === currentUser.id;
                        const playerEl = document.createElement('div');
                        playerEl.className = `player ${isCurrent ? 'current-player' : ''}`;
                        playerEl.innerHTML = `<span class="player-name">${player.username}</span>`;
                        teamAList.appendChild(playerEl);
                        if (isCurrent) currentTeam = 'A';
                    });
                    
                    const teamBList = document.getElementById('teamBPlayers');
                    teamBList.innerHTML = '';
                    
                    data.team_b.forEach(player => {
                        const isCurrent = player.user_id === currentUser.id;
                        const playerEl = document.createElement('div');
                        playerEl.className = `player ${isCurrent ? 'current-player' : ''}`;
                        playerEl.innerHTML = `<span class="player-name">${player.username}</span>`;
                        teamBList.appendChild(playerEl);
                        if (isCurrent) currentTeam = 'B';
                    });
                    
                    updateJoinButtons(data);
                    
                    const startButton = document.getElementById('startButton');
                    if (startButton) {
                        const canStart = data.team_a_count >= 2 && data.team_b_count >= 2;
                        startButton.disabled = !canStart;
                        if (!canStart) {
                            startButton.textContent = '‚è≥ –ù—É–∂–Ω–æ –ø–æ 2 –∏–≥—Ä–æ–∫–∞ –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ';
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        function updateJoinButtons(data) {
            const joinTeamABtn = document.getElementById('joinTeamABtn');
            const joinTeamBBtn = document.getElementById('joinTeamBBtn');
            
            const inTeamA = data.team_a.some(p => p.user_id === currentUser.id);
            const inTeamB = data.team_b.some(p => p.user_id === currentUser.id);
            
            if (inTeamA) {
                joinTeamABtn.innerHTML = '‚úÖ –í—ã –≤ –∫–æ–º–∞–Ω–¥–µ A';
                joinTeamABtn.disabled = true;
                joinTeamBBtn.innerHTML = 'üîÑ –ü–µ—Ä–µ–π—Ç–∏ –≤ B';
            } else if (inTeamB) {
                joinTeamABtn.innerHTML = 'üîÑ –ü–µ—Ä–µ–π—Ç–∏ –≤ A';
                joinTeamBBtn.innerHTML = '‚úÖ –í—ã –≤ –∫–æ–º–∞–Ω–¥–µ B';
                joinTeamBBtn.disabled = true;
            }
            
            if (data.team_a_count >= 4 && !inTeamA) {
                joinTeamABtn.disabled = true;
                joinTeamABtn.innerHTML = 'üö´ –ö–æ–º–∞–Ω–¥–∞ A –∑–∞–ø–æ–ª–Ω–µ–Ω–∞';
            }
            
            if (data.team_b_count >= 4 && !inTeamB) {
                joinTeamBBtn.disabled = true;
                joinTeamBBtn.innerHTML = 'üö´ –ö–æ–º–∞–Ω–¥–∞ B –∑–∞–ø–æ–ª–Ω–µ–Ω–∞';
            }
        }
        
        async function joinTeam(team) {
            try {
                const response = await fetch('/api/join-team/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser.id,
                        username: currentUser.username,
                        team: team
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`–í—ã –≤ –∫–æ–º–∞–Ω–¥–µ ${team}!`);
                    updatePlayers();
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }
        
        async function startGame() {
            if (!isCreator) {
                showError('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É');
                return;
            }
            
            try {
                const response = await fetch('/api/start-game/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
                    setTimeout(() => {
                        window.location.href = `/game/${roomId}/`;
                    }, 1000);
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }
        
        async function leaveRoom() {
            if (confirm('–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?')) {
                try {
                    const response = await fetch('/api/leave-room/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            room_id: roomId,
                            user_id: currentUser.id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    }
                } catch (error) {
                    showError('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        async function shareRoom() {
            const roomLink = window.location.href;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Alias Game',
                        text: `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–µ Alias! –ö–æ–º–Ω–∞—Ç–∞: ${roomId}`,
                        url: roomLink
                    });
                } catch (error) {
                    copyToClipboard(roomLink);
                }
            } else {
                copyToClipboard(roomLink);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }
        
        updatePlayers();
        setInterval(updatePlayers, 3000);
    </script>
</body>
</html>