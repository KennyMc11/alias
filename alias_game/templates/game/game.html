<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–∞ Alias - –ö–æ–º–Ω–∞—Ç–∞ {{ room.room_id }}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Alias</h1>
            <div class="room-id">–ö–æ–º–Ω–∞—Ç–∞: {{ room.room_id }}</div>
        </div>
        
        <div class="scores">
            <div class="score score-a">
                <div>–ö–æ–º–∞–Ω–¥–∞ A</div>
                <div class="score-value" id="scoreA">0</div>
                <div class="target">–¶–µ–ª—å: <span id="targetScore">25</span></div>
            </div>
            
            <div class="score score-b">
                <div>–ö–æ–º–∞–Ω–¥–∞ B</div>
                <div class="score-value" id="scoreB">0</div>
                <div class="target">–¶–µ–ª—å: <span id="targetScore">25</span></div>
            </div>
        </div>
        
        <div class="current-team" id="currentTeamInfo">
            –°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: <span id="currentTeam">–ö–æ–º–∞–Ω–¥–∞ A</span>
        </div>
        
        <div class="players-info">
            <div class="player-role explainer">
                <span>–û–±—ä—è—Å–Ω—è–µ—Ç:</span>
                <span id="explainerName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="player-role guesser">
                <span>–£–≥–∞–¥—ã–≤–∞–µ—Ç:</span>
                <span id="guesserName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
        
        <div class="timer" id="timer">60</div>
        
        <div class="word-container" id="wordContainer">
            <div class="word" id="currentWord">
                <span id="wordText">–ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"</span>
            </div>
        </div>
        
        <div class="controls" id="gameControls">
            <button class="btn btn-success" onclick="wordGuessed()" id="guessedBtn">
                ‚úÖ –í–µ—Ä–Ω–æ!
            </button>
            <button class="btn btn-danger" onclick="skipWord()" id="skipBtn">
                ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
            </button>
        </div>
        
        <button class="btn btn-warning" onclick="getNewWord()" id="newWordBtn">
            üîÑ –ù–æ–≤–æ–µ —Å–ª–æ–≤–æ
        </button>
        
        <button class="btn btn-secondary" onclick="nextTurn()" id="nextTurnBtn">
            ‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥
        </button>
        
        <button class="btn btn-secondary" onclick="switchTeam()" id="switchTeamBtn">
            üîÑ –°–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
        </button>
        
        <a href="/room/{{ room.room_id }}/" class="back-btn">
            ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
        </a>
        
        <div class="winner" id="winnerMessage">
            <h2>üéâ –ü–æ–±–µ–¥–∏–ª–∞ –∫–æ–º–∞–Ω–¥–∞ <span id="winnerTeam"></span>! üéâ</h2>
            <p>–°—á–µ—Ç: <span id="finalScore"></span></p>
            <button class="btn btn-primary" onclick="location.reload()">
                üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞
            </button>
        </div>
        
        <div class="message error" id="errorMessage"></div>
        <div class="message success" id="successMessage"></div>
        <div id="roomMeta" data-creator="{{ room.creator_id }}" style="display:none"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        const user = tg.initDataUnsafe?.user;
        let currentUser = null;
        
        if (user) {
            currentUser = {
                id: user.id,
                username: user.username || `User${user.id}`
            };
        } else {
            currentUser = {
                id: Math.floor(Math.random() * 1000000),
                username: 'TestUser'
            };
        }
        
        const roomId = '{{ room.room_id }}';
        let gameState = null;
        let timerInterval = null;
        let timeLeft = 60;
        let currentWord = null;
        let isExplainer = false;
        const roomCreatorId = Number(document.getElementById('roomMeta').dataset.creator);
        let isCreator = roomCreatorId === currentUser.id;
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 60;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showError('–í—Ä–µ–º—è –≤—ã—à–ª–æ!');
                    setTimeout(nextTurn, 2000);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            
            if (timeLeft <= 10) {
                timerEl.style.color = '#ff6b6b';
            } else if (timeLeft <= 30) {
                timerEl.style.color = '#ffc107';
            } else {
                timerEl.style.color = '#51cf66';
            }
        }
        
        async function updateGameState() {
            try {
                const response = await fetch(`/api/game-state/${roomId}/`);
                const data = await response.json();
                
                if (data.success) {
                    gameState = data;
                    
                    if (!data.is_game_started) {
                        document.getElementById('wordContainer').innerHTML = 
                            '<div class="waiting">–ò–≥—Ä–∞ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å</div>';
                        return;
                    }
                    
                    if (data.winner) {
                        showWinner(data.winner);
                        return;
                    }
                    
                    document.getElementById('scoreA').textContent = data.score_a;
                    document.getElementById('scoreB').textContent = data.score_b;
                    
                    const currentTeam = data.current_team === 'A' ? '–ö–æ–º–∞–Ω–¥–∞ A' : '–ö–æ–º–∞–Ω–¥–∞ B';
                    document.getElementById('currentTeam').textContent = currentTeam;
                    
                    document.getElementById('explainerName').textContent = data.explainer.username;
                    document.getElementById('guesserName').textContent = data.guesser.username;
                    
                    isExplainer = currentUser && (data.explainer.id === currentUser.id);
                    
                    const showControls = isExplainer;
                    document.getElementById('gameControls').style.display = showControls ? 'flex' : 'none';
                    document.getElementById('newWordBtn').style.display = showControls ? 'block' : 'none';
                    document.getElementById('nextTurnBtn').style.display = showControls ? 'block' : 'none';
                    document.getElementById('switchTeamBtn').style.display = isCreator ? 'block' : 'none';
                    
                    if (!isExplainer) {
                        document.getElementById('wordContainer').innerHTML = 
                            `<div class="waiting">–ñ–¥–∏—Ç–µ, —Å–µ–π—á–∞—Å –æ–±—ä—è—Å–Ω—è–µ—Ç: ${data.explainer.username}</div>`;
                    }
                    
                    timeLeft = data.time_per_turn || 60;
                    updateTimerDisplay();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        async function getNewWord() {
            if (!isExplainer) {
                showError('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                return;
            }
            
            try {
                const response = await fetch('/api/get-word/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentWord = data.word;
                    document.getElementById('wordText').textContent = currentWord;
                    startTimer();
                    showSuccess('–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ!');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }
        
        async function wordGuessed() {
            if (!isExplainer) {
                showError('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                return;
            }
            
            if (!currentWord) {
                showError('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å–ª–æ–≤–æ');
                return;
            }
            
            try {
                const response = await fetch('/api/word-guessed/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('–û—Ç–ª–∏—á–Ω–æ! +1 –æ—á–∫–æ');
                    document.getElementById('scoreA').textContent = data.score_a;
                    document.getElementById('scoreB').textContent = data.score_b;
                    
                    if (data.score_a >= 25 || data.score_b >= 25) {
                        updateGameState();
                    } else {
                        getNewWord();
                    }
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function skipWord() {
            if (!isExplainer) {
                showError('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                return;
            }
            
            showSuccess('–°–ª–æ–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ');
            getNewWord();
        }
        
        async function nextTurn() {
            if (!isExplainer) {
                showError('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                return;
            }
            
            try {
                const response = await fetch('/api/next-turn/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('–°–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥!');
                    currentWord = null;
                    document.getElementById('wordText').textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"';
                    clearInterval(timerInterval);
                    updateGameState();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function switchTeam() {
            if (!isCreator) {
                showError('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É');
                return;
            }
            
            if (confirm('–°–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É?')) {
                try {
                    const response = await fetch('/api/switch-team/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            room_id: roomId,
                            user_id: currentUser.id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('–¢–µ–ø–µ—Ä—å –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–∞—è –∫–æ–º–∞–Ω–¥–∞!');
                        currentWord = null;
                        document.getElementById('wordText').textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"';
                        clearInterval(timerInterval);
                        updateGameState();
                    }
                } catch (error) {
                    showError('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        function showWinner(winnerTeam) {
            document.getElementById('winnerTeam').textContent = winnerTeam;
            document.getElementById('finalScore').textContent = 
                `${gameState.score_a} : ${gameState.score_b}`;
            document.getElementById('winnerMessage').style.display = 'block';
        }
        
        updateGameState();
        setInterval(updateGameState, 3000);
    </script>
</body>
</html>